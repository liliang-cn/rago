# RRF（倒数排名融合）分数优化解决方案

## 问题分析

### 原始问题

- **sqvect 工作正常**：返回 28%-33%的高质量相似度分数
- **RRF 压缩过度**：k=60 导致分数被压缩到 1.6%-3.2%范围
- **阈值不匹配**：0.3 的相关性阈值对 RRF 分数来说过高

### 根本原因

RRF 公式：`score = 1.0 / (k + rank)`

当 k=60 时：

- 排名第 1：1/(60+1) = 0.0164 (1.64%)
- 排名第 2：1/(60+2) = 0.0161 (1.61%)
- 排名第 3：1/(60+3) = 0.0159 (1.59%)

即使是完美匹配，最高分也只有 1.64%，而阈值是 30%，导致所有结果都被过滤。

## 解决方案

### 1. 配置化 RRF 参数

新增配置选项：

```toml
[rrf]
k = 10                         # RRF常数（降低以减少分数压缩）
relevance_threshold = 0.05     # 相关性阈值（调整以匹配RRF分数）
```

### 2. 分数范围对比

| k 值 | 第 1 名分数 | 第 2 名分数 | 第 3 名分数 | 推荐阈值 |
| ---- | ----------- | ----------- | ----------- | -------- |
| 60   | 0.0164      | 0.0161      | 0.0159      | 0.015    |
| 10   | 0.0909      | 0.0833      | 0.0769      | 0.05     |
| 5    | 0.1667      | 0.1429      | 0.1250      | 0.10     |

### 3. 代码更改

#### processor/service.go

```go
func (s *Service) fuseResults(listA, listB []domain.Chunk) []domain.Chunk {
    k := s.config.RRF.K // 使用可配置的RRF常数
    // ...
}
```

#### cmd/rago/query.go

```go
relevanceThreshold := cfg.RRF.RelevanceThreshold
```

### 4. 环境变量支持

- `RAGO_RRF_K`: 设置 RRF k 值
- `RAGO_RRF_RELEVANCE_THRESHOLD`: 设置相关性阈值

## 使用建议

### 推荐配置

```toml
[rrf]
k = 10                    # 平衡分数范围和排序质量
relevance_threshold = 0.05 # 匹配k=10的分数范围
```

### 调优指南

1. **高精确度场景**：k=5, threshold=0.10
2. **平衡场景**：k=10, threshold=0.05
3. **高召回场景**：k=20, threshold=0.03

### 验证方法

```bash
# 测试不同k值的效果
RAGO_RRF_K=10 RAGO_RRF_RELEVANCE_THRESHOLD=0.05 ./rago query "test" --show-sources
```

## 效果预期

### 优化前 (k=60)

- RRF 分数：0.016-0.032
- 阈值：0.3
- 结果：所有文档被过滤，无相关内容

### 优化后 (k=10)

- RRF 分数：0.05-0.18
- 阈值：0.05
- 结果：高质量匹配正常返回

## 向后兼容性

- 默认值确保现有部署正常工作
- 可通过配置文件或环境变量调整
- 不影响 sqvect 原始相似度计算
